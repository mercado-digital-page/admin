<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Clientes Pro+</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.iconify.design/3/3.1.1/iconify.min.js"></script>
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }
    .modal-backdrop-blur { backdrop-filter: blur(2px); }
    .modal-scrollable-content::-webkit-scrollbar { width: 8px; }
    .modal-scrollable-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
    .modal-scrollable-content::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }
    .dynamic-item-group { padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.75rem; background-color: #f9fafb; }
    .service-image-display { width: 100%; aspect-ratio: 1 / 1; object-fit: cover; border-radius: 0.375rem; margin-bottom: 0.5rem; }
    .completeness-dot { width: 0.75rem; height: 0.75rem; border-radius: 9999px; }
    .line-clamp-2 { overflow: hidden; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#03152A', accent: '#69D6E9' }
        }
      }
    }
  </script>
</head>
<body class="bg-gray-100">
  <div class="container mx-auto px-4 py-8">
    <header class="flex flex-col md:flex-row justify-between items-center gap-4 mb-8 pb-4 border-b border-gray-300">
      <h1 class="text-4xl font-bold text-gray-800">Gestor de Clientes</h1>
      <div class="flex flex-wrap gap-2 items-center">
        <button id="addNewClientBtn" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors shadow-md"><i class="fas fa-plus mr-2"></i>Añadir Cliente</button>
        <button id="openMassMessageModalBtn" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors shadow-md"><i class="fas fa-comments mr-2"></i>Mensajes Masivos</button>
        <button id="downloadJsonBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors shadow-md"><i class="fas fa-download mr-2"></i>Descargar JSON</button>
      </div>
    </header>
    <div class="relative w-full md:w-1/2 mb-6">
        <input type="text" id="searchInput" placeholder="Buscar por nombre, categoría, slogan..." class="w-full pl-4 pr-10 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent shadow-sm">
        <button id="searchBtn" class="absolute right-0 top-0 h-full px-5 text-gray-600 hover:text-primary transition-colors"><i class="fas fa-search fa-lg"></i></button>
    </div>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="clientList"></div>
  </div>

  <div id="clientDetailsModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden items-center justify-center p-4 modal-backdrop-blur">
    <div id="clientDetailsContentWrapper" class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col overflow-hidden">
        <div class="flex justify-between items-center p-3 border-b border-gray-200 bg-gray-50">
            <div id="detailsCompletenessIndicator" class="text-sm font-medium flex items-center"></div>
            <div>
                <button id="editClientDetailsBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors mr-2" title="Editar Cliente"><i class="fas fa-edit text-gray-700 text-xl"></i></button>
                <button id="closeDetailsModalBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Cerrar Detalles"><i class="fas fa-times text-gray-700 text-xl"></i></button>
            </div>
        </div>
        <div id="clientDetailsScrollableArea" class="overflow-y-auto flex-grow modal-scrollable-content">
            <div id="detailsHeaderBanner" class="h-52 md:h-64 bg-gray-200 relative bg-cover bg-center"></div>
            <div class="relative px-6">
                <div id="detailsLogoContainer" class="absolute -top-12 md:-top-16 left-1/2 -translate-x-1/2 md:left-8 md:translate-x-0 w-24 h-24 md:w-32 md:h-32 rounded-full bg-white shadow-xl border-4 border-white overflow-hidden flex items-center justify-center">
                    <img id="clientModalLogo" src="" alt="Logo" class="w-full h-full object-cover hidden">
                    <div id="clientModalLogoInitials" class="w-full h-full flex items-center justify-center font-bold text-3xl md:text-4xl"></div>
                </div>
            </div>
            <div class="px-6 pb-6 pt-16 md:pt-20" id="detailsModalBody"></div>
        </div>
        <div id="detailsCtaSection" class="p-4 border-t border-gray-200 bg-gray-50">
             <button id="contactClientBtn" class="w-full px-6 py-3 rounded-lg font-semibold text-white hover:opacity-90 transition-opacity text-lg">Contactar Cliente</button>
        </div>
    </div>
  </div>

  <div id="clientFormModal" class="fixed inset-0 bg-black bg-opacity-50 z-[60] hidden items-center justify-center p-4 modal-backdrop-blur">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b border-gray-200">
            <h2 id="clientFormTitle" class="text-2xl font-bold text-primary"></h2>
            <button id="closeClientFormModalBtn" class="p-2 rounded-full hover:bg-gray-200 transition-colors" title="Cerrar Formulario"><i class="fas fa-times text-gray-700 text-xl"></i></button>
        </div>
        <form id="clientForm" class="flex-grow overflow-y-auto p-6 space-y-6 modal-scrollable-content"></form>
        <div class="p-4 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
            <button type="button" id="cancelClientFormBtn" class="px-5 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors">Cancelar</button>
            <button type="submit" form="clientForm" id="saveClientFormBtn" class="px-5 py-2 bg-accent text-white rounded-lg hover:opacity-90 transition-colors">Guardar</button>
        </div>
    </div>
  </div>

  <div id="massMessageModal" class="fixed inset-0 bg-black bg-opacity-50 z-[70] hidden items-center justify-center p-4 modal-backdrop-blur">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg p-6 space-y-4">
        <div class="flex justify-between items-center">
            <h3 class="text-xl font-semibold text-primary">Enviar Mensajes Masivos por WhatsApp</h3>
            <button id="closeMassMessageModalBtn" class="p-1 rounded-full hover:bg-gray-200"><i class="fas fa-times text-gray-600"></i></button>
        </div>
        <div class="flex items-start gap-2">
            <textarea id="massMessageTemplate" rows="5" class="w-full p-2 border border-gray-300 rounded-md focus:ring-primary focus:border-primary flex-grow" placeholder="Escribe tu mensaje..."></textarea>
            <button type="button" id="insertNamePlaceholderBtn" class="px-3 py-1 bg-blue-100 text-blue-700 text-sm rounded hover:bg-blue-200 self-start whitespace-nowrap">Insertar (name)</button>
        </div>
        <p class="text-xs text-gray-500">Usa `(name)` para el nombre del cliente. Ej: ¡Hola (name)!</p>
        <button id="generateMassMessageLinksBtn" class="w-full px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors">Generar Enlaces de WhatsApp</button>
        <div id="massMessageLinksContainer" class="mt-4 space-y-2 max-h-60 overflow-y-auto modal-scrollable-content"></div>
    </div>
  </div>

  <script>
    // --- Global Variables & DOM Elements ---
    let clients = [];
    let currentClient = null;
    let isEditMode = false;

    const clientListDiv = document.getElementById('clientList');
    const clientDetailsModal = document.getElementById('clientDetailsModal');
    const detailsHeaderBanner = document.getElementById('detailsHeaderBanner');
    const clientModalLogo = document.getElementById('clientModalLogo');
    const clientModalLogoInitials = document.getElementById('clientModalLogoInitials');
    const detailsModalBody = document.getElementById('detailsModalBody');
    const contactClientBtn = document.getElementById('contactClientBtn');
    const closeDetailsModalBtn = document.getElementById('closeDetailsModalBtn');
    const editClientDetailsBtn = document.getElementById('editClientDetailsBtn');
    const detailsCtaSection = document.getElementById('detailsCtaSection');
    const detailsCompletenessIndicator = document.getElementById('detailsCompletenessIndicator');

    const clientFormModal = document.getElementById('clientFormModal');
    const clientForm = document.getElementById('clientForm');
    const clientFormTitle = document.getElementById('clientFormTitle');
    const closeClientFormModalBtn = document.getElementById('closeClientFormModalBtn');
    const cancelClientFormBtn = document.getElementById('cancelClientFormBtn');
    const saveClientFormBtn = document.getElementById('saveClientFormBtn');

    const searchInput = document.getElementById('searchInput');
    const searchBtn = document.getElementById('searchBtn');
    const downloadJsonBtn = document.getElementById('downloadJsonBtn');
    const addNewClientBtn = document.getElementById('addNewClientBtn');
    
    const openMassMessageModalBtn = document.getElementById('openMassMessageModalBtn');
    const massMessageModal = document.getElementById('massMessageModal');
    const closeMassMessageModalBtn = document.getElementById('closeMassMessageModalBtn');
    const generateMassMessageLinksBtn = document.getElementById('generateMassMessageLinksBtn');
    const massMessageTemplateInput = document.getElementById('massMessageTemplate');
    const massMessageLinksContainer = document.getElementById('massMessageLinksContainer');
    const insertNamePlaceholderBtn = document.getElementById('insertNamePlaceholderBtn');

    const IMAGE_BASE_URL = "multimedia/";
    const FULL_CLIENT_STRUCTURE_KEYS = [
        "id", "name", "slogan", "services", "phones", "emails", "facebook",
        "instagram", "tiktok", "youtube", "website", "brochure", "card",
        "location", "mapsLink", "primaryColor", "accentColor", "about",
        "reliabilityScore", "whyChooseUs", "platformName", "category", "type", "gender"
    ];

    // --- Utility Functions ---
    function getInitials(name) {
        if (!name || typeof name !== 'string') return '';
        const words = name.trim().split(/\s+/);
        if (words.length === 0 || words[0] === '') return '';
        if (words.length === 1) return words[0].substring(0, 2).toUpperCase();
        return words.map(word => word[0]).join('').toUpperCase().substring(0, 2);
    }

    function sanitizePath(path) {
        if (typeof path !== 'string') return '';
        if (path.startsWith('../../../admin/clientes/')) {
            return path.substring('../../../admin/clientes/'.length);
        }
        return path;
    }
    
    function generateIdFromName(name) {
        if (!name) return `cliente-${Date.now()}`;
        const safeName = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
        return `${safeName}-${Date.now().toString().slice(-5)}`;
    }

    function kontrastFarbe(hexColor) {
        if (!hexColor || typeof hexColor !== 'string' || !hexColor.startsWith('#') || hexColor.length !== 7) return '#FFFFFF';
        try {
            const r = parseInt(hexColor.slice(1, 3), 16);
            const g = parseInt(hexColor.slice(3, 5), 16);
            const b = parseInt(hexColor.slice(5, 7), 16);
            const helligkeit = (r * 299 + g * 587 + b * 114) / 1000;
            return helligkeit > 125 ? '#000000' : '#FFFFFF';
        } catch (e) { return '#FFFFFF'; }
    }

    function getClientCompleteness(client) {
        let filledCount = 0;
        const totalFields = FULL_CLIENT_STRUCTURE_KEYS.length;

        FULL_CLIENT_STRUCTURE_KEYS.forEach(key => {
            const value = client[key];
            if (Array.isArray(value)) {
                if (value.length > 0) filledCount++;
            } else if (key === "reliabilityScore") {
                if (value !== null && value !== undefined) filledCount++;
            } else {
                if (value !== undefined && value !== null && String(value).trim() !== "") {
                    filledCount++;
                }
            }
        });
        const percentage = totalFields > 0 ? Math.round((filledCount / totalFields) * 100) : 0;
        
        let status = 'Bajo';
        let dotColorClass = 'bg-red-500';
        let textColorClass = 'text-red-700';

        if (percentage >= 95) { status = 'Completo'; dotColorClass = 'bg-green-500'; textColorClass = 'text-green-700';}
        else if (percentage >= 75) { status = 'Bueno'; dotColorClass = 'bg-yellow-500'; textColorClass = 'text-yellow-700';}
        else if (percentage >= 50) { status = 'Regular'; dotColorClass = 'bg-orange-500'; textColorClass = 'text-orange-700';}
        
        return { percentage, status, dotColorClass, textColorClass, filledCount, totalFields };
    }

    // --- Data Handling ---
    async function loadClients() {
      try {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        let jsonData = await response.json();
        
        clients = jsonData.map(client => {
            const newClient = { ...client };
            if (newClient.services) {
                newClient.services = newClient.services.map(service => ({
                    ...service,
                    image: service.image && !service.image.startsWith('http') ? sanitizePath(service.image) : service.image
                }));
            }
            if (newClient.logo && !newClient.logo.startsWith('http')) newClient.logo = sanitizePath(newClient.logo);
            return newClient;
        });
        renderClientList(clients);
      } catch (error) {
        console.error('Error al cargar los clientes:', error);
        clientListDiv.innerHTML = `<p class="col-span-full text-center text-red-500">Error al cargar datos: ${error.message}</p>`;
      }
    }

    // --- Rendering Functions ---
    function renderClientList(clientsToDisplay) {
      clientListDiv.innerHTML = '';
      if (!clientsToDisplay || clientsToDisplay.length === 0) {
        clientListDiv.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No se encontraron clientes.</p>`;
        return;
      }
      clientsToDisplay.forEach(client => {
        const profilePicUrl = client.id ? `${IMAGE_BASE_URL}${client.id}/profile.png` : (client.logo || '');
        const bannerUrl = client.id ? `${IMAGE_BASE_URL}${client.id}/banner.png` : '';
        const completeness = getClientCompleteness(client);
        
        const card = document.createElement('div');
        card.className = "bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-2xl transition-all duration-300 ease-in-out transform hover:-translate-y-1 cursor-pointer flex flex-col";
        card.dataset.id = client.id;
        card.innerHTML = `
          <div class="h-40 bg-cover bg-center card-banner" style="background-color: ${client.primaryColor || '#E0E0E0'};"></div>
          <div class="p-5 relative flex-grow flex flex-col">
            <div class="absolute top-2 right-2 flex items-center p-1 bg-white/70 backdrop-blur-sm rounded-full text-xs ${completeness.textColorClass}" title="Completitud: ${completeness.status} (${completeness.filledCount}/${completeness.totalFields} campos)">
                <span class="completeness-dot ${completeness.dotColorClass} mr-1"></span>
                ${completeness.percentage}%
            </div>
            <div class="absolute -top-10 left-1/2 -translate-x-1/2 w-20 h-20 rounded-full border-4 border-white bg-gray-100 shadow-md overflow-hidden flex items-center justify-center">
              <img src="${profilePicUrl}" alt="${client.name || 'Cliente'} logo" class="w-full h-full object-cover client-card-profile-img" style="display: ${profilePicUrl ? 'block' : 'none'};">
              <span class="text-2xl font-bold client-card-profile-initials" style="color: ${client.primaryColor || '#333'}; display: ${profilePicUrl ? 'none' : 'flex'};">${getInitials(client.name)}</span>
            </div>
            <h3 class="text-xl font-bold text-center mt-10 mb-1" style="color: ${client.primaryColor || '#333'};">${client.name || 'Nombre no disponible'}</h3>
            <p class="text-sm text-gray-500 italic text-center mb-3 h-10 overflow-hidden line-clamp-2" title="${client.slogan || ''}">${client.slogan || 'Sin slogan'}</p>
            <div class="mt-auto text-center">
                <span class="inline-block px-3 py-1 text-xs rounded-full font-semibold" style="background-color: ${client.accentColor || '#F0F0F0'}; color: ${kontrastFarbe(client.accentColor || '#F0F0F0')};">
                    ${client.category || 'Sin categoría'}
                </span>
            </div>
          </div>
        `;
        
        const bannerDiv = card.querySelector('.card-banner');
        if (bannerUrl) {
            const img = new Image();
            img.src = bannerUrl;
            img.onload = () => { bannerDiv.style.backgroundImage = `url('${bannerUrl}')`; };
            // If error, it keeps the primaryColor background
        }

        const imgElement = card.querySelector('.client-card-profile-img');
        if (imgElement) {
            imgElement.onerror = function() {
                this.style.display = 'none';
                const initialsSpan = this.nextElementSibling;
                if (initialsSpan && initialsSpan.classList.contains('client-card-profile-initials')) {
                    initialsSpan.style.display = 'flex';
                }
            };
        }

        card.addEventListener('click', () => showClientDetails(client.id));
        clientListDiv.appendChild(card);
      });
    }

    function showClientDetails(clientId) {
        currentClient = clients.find(c => c.id === clientId);
        if (!currentClient) return;

        const profilePicUrl = currentClient.id ? `${IMAGE_BASE_URL}${currentClient.id}/profile.png` : (currentClient.logo || '');
        const bannerUrl = currentClient.id ? `${IMAGE_BASE_URL}${currentClient.id}/banner.png` : '';

        detailsHeaderBanner.style.backgroundImage = 'none';
        detailsHeaderBanner.style.backgroundColor = currentClient.primaryColor || '#E0E0E0';
        if (bannerUrl) {
            const bannerImgTest = new Image();
            bannerImgTest.src = bannerUrl;
            bannerImgTest.onload = () => {
                detailsHeaderBanner.style.backgroundImage = `url('${bannerUrl}')`;
                detailsHeaderBanner.style.backgroundColor = 'transparent';
            };
        }

        clientModalLogo.src = ''; // Reset src
        clientModalLogo.classList.add('hidden');
        clientModalLogoInitials.classList.add('hidden');
        if (profilePicUrl) {
            clientModalLogo.src = profilePicUrl;
            clientModalLogo.alt = `${currentClient.name} Logo`;
            clientModalLogo.classList.remove('hidden');
            clientModalLogo.onerror = () => {
                clientModalLogo.classList.add('hidden');
                clientModalLogoInitials.textContent = getInitials(currentClient.name);
                clientModalLogoInitials.style.color = currentClient.primaryColor || '#333';
                clientModalLogoInitials.classList.remove('hidden');
            };
        } else {
            clientModalLogoInitials.textContent = getInitials(currentClient.name);
            clientModalLogoInitials.style.color = currentClient.primaryColor || '#333';
            clientModalLogoInitials.classList.remove('hidden');
        }
        clientModalLogoInitials.parentElement.style.borderColor = currentClient.accentColor || 'white';
        
        const completeness = getClientCompleteness(currentClient);
        detailsCompletenessIndicator.innerHTML = `<span class="completeness-dot ${completeness.dotColorClass} mr-2"></span> Completitud: ${completeness.percentage}% (${completeness.status} - ${completeness.filledCount}/${completeness.totalFields} campos)`;
        detailsCompletenessIndicator.className = `text-sm font-medium flex items-center ${completeness.textColorClass}`;

        let servicesHTML = currentClient.services && currentClient.services.length > 0 ?
            currentClient.services.map(s => `
                <div class="bg-gray-50 p-4 rounded-lg shadow text-center">
                    ${s.image ? `<img src="${s.image.startsWith('http') ? s.image : sanitizePath(s.image)}" alt="${s.name || 'Servicio'}" class="service-image-display mx-auto">` : ''}
                    <div class="flex items-center justify-center mb-1 mt-2">
                        ${s.icon ? `<iconify-icon icon="${s.icon}" class="text-2xl mr-2" style="color: ${currentClient.accentColor || '#777'}"></iconify-icon>` : '<div class="w-6 mr-2"></div>' }
                        <h4 class="font-semibold text-md" style="color: ${currentClient.primaryColor || '#333'}">${s.name || 'Servicio sin nombre'}</h4>
                    </div>
                    <p class="text-sm text-gray-600">${s.description || ''}</p>
                </div>`).join('') : '<p class="text-sm text-gray-500">No hay servicios listados.</p>';

        let whyChooseUsHTML = currentClient.whyChooseUs && currentClient.whyChooseUs.length > 0 ?
            currentClient.whyChooseUs.map(w => `
                <div class="bg-gray-50 p-3 rounded-lg flex items-start">
                     ${w.icon ? `<iconify-icon icon="${w.icon}" class="text-3xl mr-3 flex-shrink-0" style="color: ${currentClient.accentColor || '#777'}; margin-top: 0.125rem;"></iconify-icon>` : '<div class="w-8 mr-3 flex-shrink-0"></div>'}
                     <div>
                        <h4 class="font-medium text-sm mb-0.5" style="color: ${currentClient.primaryColor || '#333'}">${w.title || 'Razón sin título'}</h4>
                        <p class="text-xs text-gray-600">${w.text || ''}</p>
                    </div>
                </div>`).join('') : '<p class="text-sm text-gray-500">Información no disponible.</p>';
        
        let phonesHTML = currentClient.phones && currentClient.phones.length > 0 ?
            currentClient.phones.map(p => `
                <div class="flex items-center gap-2 text-sm mb-1">
                    <i class="fas fa-phone fa-fw" style="color: ${currentClient.accentColor || '#777'}"></i> ${p.number || ''}
                    ${p.whatsapp ? `<a href="https://wa.me/${String(p.whatsapp).replace(/\D/g,'')}" target="_blank" class="text-green-500 hover:text-green-600"><i class="fab fa-whatsapp"></i> ${p.ctaText || 'WhatsApp'}</a>` : ''}
                </div>`).join('') : '<p class="text-sm text-gray-500">No disponible</p>';

        let emailsHTML = currentClient.emails && currentClient.emails.length > 0 ?
            currentClient.emails.map(e => `<div class="flex items-center gap-2 text-sm mb-1"><i class="fas fa-envelope fa-fw" style="color: ${currentClient.accentColor || '#777'}"></i> <a href="mailto:${e}" class="hover:underline break-all">${e}</a></div>`).join('') : '<p class="text-sm text-gray-500">No disponible</p>';
        
        const socialLinksData = [ /* Defined as in previous thoughts */
            { key: 'facebook', icon: 'fab fa-facebook-f', color: '#1877F2' },
            { key: 'instagram', icon: 'fab fa-instagram', color: 'radial-gradient(circle at 30% 107%, #fdf497 0%, #fdf497 5%, #fd5949 45%, #d6249f 60%, #285AEB 90%)' },
            { key: 'tiktok', icon: 'fab fa-tiktok', color: '#000000' },
            { key: 'youtube', icon: 'fab fa-youtube', color: '#FF0000' }
        ];
        let socialHTML = socialLinksData.map(s => currentClient[s.key] ? `<a href="${currentClient[s.key]}" target="_blank" class="w-8 h-8 rounded-full flex items-center justify-center text-white hover:opacity-80 transition-opacity" style="background: ${s.color};" title="${s.key.charAt(0).toUpperCase() + s.key.slice(1)}"><i class="${s.icon} text-sm"></i></a>` : '').filter(Boolean).join('');
        if (!socialHTML.trim()) socialHTML = '<p class="text-sm text-gray-500">No disponible</p>';

        let otrosEnlacesPresent = false;
        let otrosEnlacesHTML = '';
        if (currentClient.website) { otrosEnlacesHTML += linkDetailItem('fas fa-globe', 'Sitio Web', currentClient.website, currentClient.accentColor); otrosEnlacesPresent = true; }
        if (currentClient.brochure) { otrosEnlacesHTML += linkDetailItem('fas fa-file-pdf', 'Brochure', currentClient.brochure, currentClient.accentColor); otrosEnlacesPresent = true; }
        if (currentClient.card) { otrosEnlacesHTML += linkDetailItem('fas fa-id-card', 'Tarjeta Digital', currentClient.card, currentClient.accentColor); otrosEnlacesPresent = true; }
        if (currentClient.mapsLink && currentClient.mapsLink !== "https://maps.app.goo.gl/mKuKNqi48YJ9URpb7" && currentClient.mapsLink.trim() !== "") {
            otrosEnlacesHTML += linkDetailItem('fas fa-map-marked-alt', 'Ver en Mapa', currentClient.mapsLink, currentClient.accentColor);
            otrosEnlacesPresent = true;
        }
        if (!otrosEnlacesPresent) otrosEnlacesHTML = '<p class="text-sm text-gray-500">No disponible</p>';

        detailsModalBody.innerHTML = `
            <h1 class="text-3xl md:text-4xl font-bold text-center mt-0 mb-1" style="color: ${currentClient.primaryColor || '#333'}">${currentClient.name || 'Cliente'}</h1>
            <p class="text-md text-gray-600 italic text-center mb-6">${currentClient.slogan || ''}</p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-sm">
                ${simpleDetailItem('fas fa-map-marker-alt', currentClient.location, currentClient.accentColor)}
                ${simpleDetailItem('fas fa-tag', currentClient.category, currentClient.accentColor)}
                ${simpleDetailItem('fas fa-user-tie', currentClient.type, currentClient.accentColor)}
                ${simpleDetailItem('fas fa-venus-mars', currentClient.gender, currentClient.accentColor)}
                ${currentClient.reliabilityScore !== null ? simpleDetailItem('fas fa-shield-alt', `Confianza: ${currentClient.reliabilityScore}%`, currentClient.accentColor) : ''}
            </div>
            ${generateSectionHTML("Acerca de", currentClient.about ? `<p class="text-gray-700 whitespace-pre-wrap">${currentClient.about}</p>` : '<p class="text-sm text-gray-500">No disponible.</p>', currentClient.accentColor, currentClient.primaryColor)}
            ${generateSectionHTML("Servicios", `<div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">${servicesHTML}</div>`, currentClient.accentColor, currentClient.primaryColor)}
            ${generateSectionHTML("¿Por qué elegirnos?", `<div class="space-y-3">${whyChooseUsHTML}</div>`, currentClient.accentColor, currentClient.primaryColor)}
            <h3 class="text-lg font-semibold mt-6 mb-2 pb-1 border-b-2" style="border-color: ${currentClient.accentColor || '#DDD'}; color: ${currentClient.primaryColor || '#333'}">Contacto</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div><h4 class="font-medium text-sm mb-1" style="color: ${currentClient.primaryColor || '#333'}">Teléfonos:</h4> ${phonesHTML}</div>
                <div><h4 class="font-medium text-sm mb-1" style="color: ${currentClient.primaryColor || '#333'}">Correos:</h4> ${emailsHTML}</div>
                <div><h4 class="font-medium text-sm mb-1" style="color: ${currentClient.primaryColor || '#333'}">Redes Sociales:</h4> <div class="flex gap-2 mt-1 flex-wrap">${socialHTML}</div></div>
                <div><h4 class="font-medium text-sm mb-1" style="color: ${currentClient.primaryColor || '#333'}">Otros Enlaces:</h4> ${otrosEnlacesHTML}</div>
            </div>
        `;
        
        contactClientBtn.textContent = "Contactar Cliente";
        contactClientBtn.style.backgroundColor = currentClient.accentColor || '#69D6E9';
        contactClientBtn.style.color = kontrastFarbe(currentClient.accentColor || '#69D6E9');
        const primaryCtaPhone = currentClient.phones?.find(p => p.isPrimaryCta && p.whatsapp);
        if (primaryCtaPhone) {
            contactClientBtn.onclick = () => window.open(`https://wa.me/${String(primaryCtaPhone.whatsapp).replace(/\D/g, '')}`, '_blank');
            detailsCtaSection.classList.remove('hidden');
        } else if(currentClient.emails && currentClient.emails.length > 0) {
            contactClientBtn.onclick = () => window.location.href = `mailto:${currentClient.emails[0]}`;
            detailsCtaSection.classList.remove('hidden');
        } else {
            detailsCtaSection.classList.add('hidden');
        }

        clientDetailsModal.classList.remove('hidden');
        clientDetailsModal.classList.add('flex');
    }
    
    function simpleDetailItem(icon, text, accentColor) {
        if (!text && text !== 0) return ''; // Allow 0 for reliability score, for example
        return `<div class="flex items-center"><i class="${icon} mr-2 w-4 text-center" style="color: ${accentColor || '#777'}"></i> <span class="text-gray-700">${text}</span></div>`;
    }
    function linkDetailItem(icon, label, url, accentColor) {
        if (!url) return '';
        return `<div class="flex items-center text-sm mb-1"><i class="${icon} mr-2 w-4 text-center" style="color: ${accentColor || '#777'}"></i> <a href="${url}" target="_blank" class="text-blue-600 hover:underline break-all">${label}</a></div>`;
    }
    function generateSectionHTML(title, content, accentColor, primaryColor = '#333') {
        return `
            <div class="mt-6">
                <h3 class="text-lg font-semibold mb-2 pb-1 border-b-2" style="border-color: ${accentColor || '#DDD'}; color: ${primaryColor || '#333'}">${title}</h3>
                ${content}
            </div>`;
    }

    // --- Form Handling (Add/Edit) ---
    function openClientForm(clientToEdit = null) {
        isEditMode = !!clientToEdit;
        const formData = isEditMode ? JSON.parse(JSON.stringify(clientToEdit)) : {};

        clientFormTitle.textContent = isEditMode ? `Editar: ${formData.name || 'Cliente'}` : 'Añadir Nuevo Cliente';
        saveClientFormBtn.textContent = isEditMode ? 'Guardar Cambios' : 'Añadir Cliente';
        
        clientForm.innerHTML = `<input type="hidden" id="form-input-id" name="id" value="${isEditMode ? (formData.id || '') : ''}">`;

        const formFields = [
            { id: 'name', label: 'Nombre de la Empresa', type: 'text', required: true },
            { id: 'slogan', label: 'Slogan', type: 'text' },
            { id: 'primaryColor', label: 'Color Primario', type: 'color', defaultValue: '#03152A' },
            { id: 'accentColor', label: 'Color de Acento', type: 'color', defaultValue: '#69D6E9' },
            { id: 'about', label: 'Acerca de', type: 'textarea', rows: 3 },
            { id: 'category', label: 'Categoría', type: 'text' },
            { id: 'type', label: 'Tipo', type: 'select', options: ['Empresa', 'Técnico', 'Freelancer', 'Otro'] },
            { id: 'gender', label: 'Género (Marca/Contacto)', type: 'select', options: ['Masculino', 'Femenino', 'Mixto', 'No especificado'] },
            { id: 'location', label: 'Ubicación', type: 'text' },
            { id: 'mapsLink', label: 'Enlace Google Maps', type: 'url' },
            { id: 'reliabilityScore', label: 'Puntaje de Confiabilidad (0-100)', type: 'number', min:0, max:100 },
            { id: 'platformName', label: 'Nombre de Plataforma (si aplica)', type: 'text' },
            { id: 'facebook', label: 'Facebook URL', type: 'url' },
            { id: 'instagram', label: 'Instagram URL', type: 'url' },
            { id: 'tiktok', label: 'TikTok URL', type: 'url' },
            { id: 'youtube', label: 'YouTube URL', type: 'url' },
            { id: 'website', label: 'Sitio Web URL', type: 'url' },
            { id: 'brochure', label: 'Brochure URL', type: 'url' },
            { id: 'card', label: 'Tarjeta Digital URL', type: 'url' },
            // Fallback/override image fields if needed. Profile/Banner primarily from ID.
            { id: 'logo', label: 'Logo Fallback URL (ej: multimedia/cliente/logo.png)', type: 'text' },
        ];

        formFields.forEach(field => clientForm.appendChild(createFormField(field, formData[field.id])));
        
        clientForm.appendChild(createArrayFieldSection('Emails', 'emails', formData.emails || [], createEmailInputGroup));
        clientForm.appendChild(createArrayFieldSection('Teléfonos', 'phones', formData.phones || [], createPhoneInputGroup));
        clientForm.appendChild(createArrayFieldSection('Servicios', 'services', formData.services || [], createServiceInputGroup));
        clientForm.appendChild(createArrayFieldSection('Razones para Elegirnos (WhyChooseUs)', 'whyChooseUs', formData.whyChooseUs || [], createWhyChooseUsInputGroup));

        if(clientDetailsModal.classList.contains('flex')) {
            clientDetailsModal.classList.add('hidden');
            clientDetailsModal.classList.remove('flex');
        }
        clientFormModal.classList.remove('hidden');
        clientFormModal.classList.add('flex');
    }

    function createFormField(fieldConfig, value) {
        const div = document.createElement('div');
        const label = document.createElement('label');
        label.htmlFor = `form-input-${fieldConfig.id}`;
        label.className = "block text-sm font-medium text-gray-700 mb-1";
        label.textContent = fieldConfig.label;
        div.appendChild(label);

        let inputElement;
        if (fieldConfig.type === 'textarea') {
            inputElement = document.createElement('textarea');
            inputElement.rows = fieldConfig.rows || 3;
        } else if (fieldConfig.type === 'select') {
            inputElement = document.createElement('select');
            fieldConfig.options.forEach(optText => {
                const option = document.createElement('option');
                option.value = optText; 
                option.textContent = optText;
                if (value === optText) option.selected = true;
                inputElement.appendChild(option);
            });
             // Set default value for select if `value` is undefined but `defaultValue` is present (though less common for select)
            if (value === undefined && fieldConfig.defaultValue !== undefined) {
                inputElement.value = fieldConfig.defaultValue;
            } else if (value !== undefined) {
                 inputElement.value = value;
            }

        } else {
            inputElement = document.createElement('input');
            inputElement.type = fieldConfig.type;
             if (fieldConfig.type === 'color') {
                 inputElement.value = (value && value.startsWith('#')) ? value : (value ? `#${String(value).padStart(6, '0')}` : (fieldConfig.defaultValue || '#000000'));
            } else if(fieldConfig.type === 'number'){
                if(fieldConfig.min !== undefined) inputElement.min = fieldConfig.min;
                if(fieldConfig.max !== undefined) inputElement.max = fieldConfig.max;
                inputElement.value = (value !== null && value !== undefined) ? value : (fieldConfig.defaultValue || '');
            } else {
                 inputElement.value = (value !== null && value !== undefined) ? value : (fieldConfig.defaultValue || '');
            }
        }
        inputElement.id = `form-input-${fieldConfig.id}`;
        inputElement.name = fieldConfig.id;
        inputElement.className = "w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent";
        
        if (fieldConfig.required) inputElement.required = true;
        
        if (fieldConfig.type === 'color') {
            const colorContainer = document.createElement('div');
            colorContainer.className = 'flex items-center gap-2';
            const colorTextInput = document.createElement('input');
            colorTextInput.type = 'text';
            colorTextInput.placeholder = '#RRGGBB';
            colorTextInput.className = 'flex-1 px-3 py-1 border border-gray-300 rounded-md text-sm';
            colorTextInput.value = inputElement.value.toUpperCase();
            
            inputElement.style.width = '40px'; inputElement.style.height = '40px'; inputElement.style.padding = '0.25rem';

            inputElement.addEventListener('input', () => colorTextInput.value = inputElement.value.toUpperCase());
            colorTextInput.addEventListener('input', (e) => {
                if (/^#[0-9A-F]{6}$/i.test(e.target.value)) inputElement.value = e.target.value;
            });
            colorContainer.appendChild(inputElement);
            colorContainer.appendChild(colorTextInput);
            div.appendChild(colorContainer);
        } else {
            div.appendChild(inputElement);
        }
        return div;
    }
    
    function createArrayFieldSection(title, fieldKey, itemsArray = [], itemGroupRenderer) {
        const sectionDiv = document.createElement('div');
        sectionDiv.className = 'py-3 border-t border-b border-gray-200';
        sectionDiv.innerHTML = `<h3 class="text-md font-semibold text-gray-800 mb-2">${title}</h3>`;
        
        const itemsContainer = document.createElement('div');
        itemsContainer.id = `form-${fieldKey}-container`; // Unique ID for container
        itemsContainer.className = 'space-y-3';
        (itemsArray || []).forEach((item, index) => itemsContainer.appendChild(itemGroupRenderer(item, index)));
        sectionDiv.appendChild(itemsContainer);

        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'mt-2 px-3 py-1 bg-blue-500 text-white rounded-md text-sm hover:bg-blue-600 transition-colors';
        addButton.innerHTML = `<i class="fas fa-plus mr-1"></i> Añadir`;
        addButton.addEventListener('click', () => {
            const newItemIndex = itemsContainer.children.length;
            itemsContainer.appendChild(itemGroupRenderer({}, newItemIndex));
        });
        sectionDiv.appendChild(addButton);
        return sectionDiv;
    }

    function createEmailInputGroup(email = '', index) {
        const div = document.createElement('div');
        div.className = 'flex items-center gap-2 dynamic-item-group';
        div.innerHTML = `
            <input type="email" value="${typeof email === 'string' ? email : ''}" placeholder="correo@ejemplo.com" class="form-input flex-grow data-email-input px-2 py-1 border border-gray-300 rounded-md text-sm">
            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-xs p-1"><i class="fas fa-trash"></i></button>
        `;
        div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
        return div;
    }
    function createPhoneInputGroup(phone = {}, index) {
         const div = document.createElement('div');
        div.className = 'p-3 border rounded-md space-y-2 dynamic-item-group data-phone-group';
        div.innerHTML = `
            <p class="text-xs font-medium text-gray-600">Teléfono ${index + 1}</p>
            <input type="text" placeholder="Número (+51 9...)" value="${phone.number || ''}" class="form-input w-full data-phone-number px-2 py-1 border border-gray-300 rounded-md text-sm">
            <input type="text" placeholder="WhatsApp (519...)" value="${phone.whatsapp || ''}" class="form-input w-full data-phone-whatsapp px-2 py-1 border border-gray-300 rounded-md text-sm">
            <input type="text" placeholder="Texto CTA (¡Cotiza!)" value="${phone.ctaText || ''}" class="form-input w-full data-phone-ctatext px-2 py-1 border border-gray-300 rounded-md text-sm">
            <label class="flex items-center text-sm"><input type="checkbox" ${phone.isPrimaryCta ? 'checked' : ''} class="form-checkbox data-phone-isprimarycta mr-2"> Es CTA principal</label>
            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-xs p-1"><i class="fas fa-trash"></i> Eliminar Teléfono</button>
        `;
        div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
        return div;
    }
    function createServiceInputGroup(service = {}, index) {
        const div = document.createElement('div');
        div.className = 'p-3 border rounded-md space-y-2 dynamic-item-group data-service-group';
        div.innerHTML = `
            <p class="text-xs font-medium text-gray-600">Servicio ${index + 1}</p>
            <input type="text" placeholder="Nombre del Servicio" value="${service.name || ''}" class="form-input w-full data-service-name px-2 py-1 border border-gray-300 rounded-md text-sm">
            <input type="text" placeholder="Icono (ej: mdi:tools)" value="${service.icon || ''}" class="form-input w-full data-service-icon px-2 py-1 border border-gray-300 rounded-md text-sm">
            <input type="text" placeholder="Ruta Imagen (ej: multimedia/cliente/servicio.png)" value="${service.image || ''}" class="form-input w-full data-service-image px-2 py-1 border border-gray-300 rounded-md text-sm">
            <textarea placeholder="Descripción del Servicio" class="form-textarea w-full data-service-description px-2 py-1 border border-gray-300 rounded-md text-sm" rows="2">${service.description || ''}</textarea>
            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-xs p-1"><i class="fas fa-trash"></i> Eliminar Servicio</button>
        `;
        div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
        return div;
    }
    function createWhyChooseUsInputGroup(item = {}, index) {
        const div = document.createElement('div');
        div.className = 'p-3 border rounded-md space-y-2 dynamic-item-group data-whychooseus-group';
        div.innerHTML = `
            <p class="text-xs font-medium text-gray-600">Razón ${index + 1}</p>
            <input type="text" placeholder="Título de la Razón" value="${item.title || ''}" class="form-input w-full data-whychooseus-title px-2 py-1 border border-gray-300 rounded-md text-sm">
            <input type="text" placeholder="Icono (ej: mdi:star)" value="${item.icon || ''}" class="form-input w-full data-whychooseus-icon px-2 py-1 border border-gray-300 rounded-md text-sm">
            <textarea placeholder="Texto de la Razón" class="form-textarea w-full data-whychooseus-text px-2 py-1 border border-gray-300 rounded-md text-sm" rows="2">${item.text || ''}</textarea>
            <button type="button" class="remove-item-btn text-red-500 hover:text-red-700 text-xs p-1"><i class="fas fa-trash"></i> Eliminar Razón</button>
        `;
        div.querySelector('.remove-item-btn').addEventListener('click', () => div.remove());
        return div;
    }
    
    function handleClientFormSubmit(e) {
        e.preventDefault();
        const formClientId = clientForm.querySelector('#form-input-id').value;
        const newClientData = { id: formClientId };

        clientForm.querySelectorAll('input[name][id^="form-input-"], textarea[name][id^="form-input-"], select[name][id^="form-input-"]').forEach(input => {
            if (input.name === 'id') return;
            const key = input.name;
            if (input.type === 'number' && key === 'reliabilityScore') {
                newClientData[key] = input.value ? parseInt(input.value) : null;
            } else if (input.type === 'checkbox') { // Not used directly in this form config but good to have
                newClientData[key] = input.checked;
            } else {
                newClientData[key] = input.value.trim();
            }
        });
        
        newClientData.emails = Array.from(clientForm.querySelectorAll('#form-emails-container .data-email-input')).map(input => input.value.trim()).filter(Boolean);
        newClientData.phones = Array.from(clientForm.querySelectorAll('#form-phones-container .data-phone-group'))
            .map(group => ({
                number: group.querySelector('.data-phone-number').value.trim(),
                whatsapp: group.querySelector('.data-phone-whatsapp').value.trim(),
                ctaText: group.querySelector('.data-phone-ctatext').value.trim(),
                isPrimaryCta: group.querySelector('.data-phone-isprimarycta').checked
            })).filter(p => p.number);
        newClientData.services = Array.from(clientForm.querySelectorAll('#form-services-container .data-service-group'))
            .map(group => ({
                name: group.querySelector('.data-service-name').value.trim(),
                icon: group.querySelector('.data-service-icon').value.trim(),
                image: sanitizePath(group.querySelector('.data-service-image').value.trim()),
                description: group.querySelector('.data-service-description').value.trim()
            })).filter(s => s.name);
        newClientData.whyChooseUs = Array.from(clientForm.querySelectorAll('#form-whyChooseUs-container .data-whychooseus-group'))
            .map(group => ({
                title: group.querySelector('.data-whychooseus-title').value.trim(),
                icon: group.querySelector('.data-whychooseus-icon').value.trim(),
                text: group.querySelector('.data-whychooseus-text').value.trim()
            })).filter(w => w.title);

        if (isEditMode && formClientId) {
            const clientIndex = clients.findIndex(c => c.id === formClientId);
            if (clientIndex !== -1) {
                clients[clientIndex] = { ...clients[clientIndex], ...newClientData };
                currentClient = clients[clientIndex]; 
            } else {
                alert("Error al editar: Cliente no encontrado."); return;
            }
        } else {
            newClientData.id = generateIdFromName(newClientData.name);
            clients.push(newClientData);
            currentClient = newClientData;
        }
        
        renderClientList(clients);
        clientFormModal.classList.add('hidden');
        clientFormModal.classList.remove('flex');
        
        if (currentClient && currentClient.id) showClientDetails(currentClient.id); 
        alert(`Cliente ${isEditMode ? 'actualizado' : 'añadido'} exitosamente (en memoria).`);
    }

    // --- Event Listeners ---
    searchBtn.addEventListener('click', () => {
        const searchTerm = searchInput.value.toLowerCase().trim();
        if (!searchTerm) { renderClientList(clients); return; }
        const filtered = clients.filter(client => 
            (client.name && client.name.toLowerCase().includes(searchTerm)) ||
            (client.category && client.category.toLowerCase().includes(searchTerm)) ||
            (client.slogan && client.slogan.toLowerCase().includes(searchTerm)) ||
            (client.services && client.services.some(s => s.name && s.name.toLowerCase().includes(searchTerm)))
        );
        renderClientList(filtered);
    });
    searchInput.addEventListener('input', () => searchBtn.click());

    downloadJsonBtn.addEventListener('click', () => {
        const jsonData = JSON.stringify(clients, null, 2);
        const blob = new Blob([jsonData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    addNewClientBtn.addEventListener('click', () => openClientForm(null));

    closeDetailsModalBtn.addEventListener('click', () => {
        clientDetailsModal.classList.add('hidden');
        clientDetailsModal.classList.remove('flex');
        currentClient = null;
    });
    clientDetailsModal.addEventListener('click', (e) => { if (e.target === clientDetailsModal) closeDetailsModalBtn.click(); });
    editClientDetailsBtn.addEventListener('click', () => {
        if (currentClient) openClientForm(currentClient);
    });

    clientForm.addEventListener('submit', handleClientFormSubmit);
    closeClientFormModalBtn.addEventListener('click', () => {
        clientFormModal.classList.add('hidden');
        clientFormModal.classList.remove('flex');
    });
    cancelClientFormBtn.addEventListener('click', () => closeClientFormModalBtn.click());
    clientFormModal.addEventListener('click', (e) => { if (e.target === clientFormModal) closeClientFormModalBtn.click(); });

    openMassMessageModalBtn.addEventListener('click', () => {
        massMessageModal.classList.remove('hidden');
        massMessageModal.classList.add('flex');
        massMessageTemplateInput.value = localStorage.getItem('massMessageTemplate') || "¡Hola (name)! Novedades en nuestros servicios este mes.";
        massMessageLinksContainer.innerHTML = '';
    });
    closeMassMessageModalBtn.addEventListener('click', () => {
        massMessageModal.classList.add('hidden');
        massMessageModal.classList.remove('flex');
    });
    massMessageModal.addEventListener('click', (e) => { if (e.target === massMessageModal) closeMassMessageModalBtn.click(); });
    generateMassMessageLinksBtn.addEventListener('click', () => { /* ... (same logic as before) ... */ });
    insertNamePlaceholderBtn.addEventListener('click', () => {
        const cursorPos = massMessageTemplateInput.selectionStart;
        const text = massMessageTemplateInput.value;
        const placeholder = "(name)"; // Corrected to match usage
        massMessageTemplateInput.value = text.slice(0, cursorPos) + placeholder + text.slice(cursorPos);
        massMessageTemplateInput.focus();
        massMessageTemplateInput.setSelectionRange(cursorPos + placeholder.length, cursorPos + placeholder.length);
    });

    document.addEventListener('DOMContentLoaded', loadClients);
  </script>
</body>
</html>